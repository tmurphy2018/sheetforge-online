<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SheetForge ‚Äì Visual Builder</title>
<style>
  :root{--bg:#ffffff;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--ok:#10b981;--accent:#111827}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 16px}
  .btn{padding:8px 10px;border:1px solid var(--border);background:#fff;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--ok);border-color:var(--ok);color:#fff}
  main{display:grid;grid-template-columns:320px 1fr 320px;gap:12px;padding:12px;height:calc(100vh - 64px)}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer;margin-right:6px}
  .tab.active{outline:2px solid var(--accent)}
  .block{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:12px;padding:10px;cursor:pointer;margin-top:8px}
  .stage{position:relative;height:calc(100% - 100px);border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff}
  .gridwrap{position:relative;padding:16px}
  .cells{display:grid;grid-template-columns:repeat(36,40px);gap:4px}
  .cell{width:40px;height:40px;border:1px solid #f1f5f9;border-radius:8px}
  .canvas{position:relative;min-width:1080px;min-height:720px;background:repeating-linear-gradient(90deg,#fafafa,#fafafa 40px,#f5f5f5 40px,#f5f5f5 41px),repeating-linear-gradient(0deg,#fafafa,#fafafa 40px,#f5f5f5 40px,#f5f5f5 41px)}
  .widget{position:absolute;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.06);padding:8px;user-select:none}
  .widget.sel{outline:2px solid var(--accent)}
  .ttl{font-weight:800;font-size:13px}.sub{font-size:12px;color:#64748b}
  .box{margin-top:6px;border:1px dashed var(--border);border-radius:10px;height:calc(100% - 36px)}
  .handle{position:absolute;width:12px;height:12px;background:#111;border-radius:3px;right:-6px;bottom:-6px;cursor:nwse-resize}
  .footer{position:sticky;bottom:0;border-top:1px solid var(--border);padding:8px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between;background:#fff;border-radius:0 0 12px 12px}
  .inp{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:36px;height:36px;border-radius:10px;background:#111;color:#fff;display:grid;place-items:center;font-weight:800">SF</div>
      <div>
        <div style="font-weight:800">SheetForge Visual Builder</div>
        <div style="font-size:13px;color:#64748b">Grid + Canvas ‚Ä¢ Multi-sheet ‚Ä¢ Smart Save-As</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <input id="projectName" value="Untitled Workbook" style="border:1px solid var(--border);border-radius:8px;padding:6px 8px;">
      <button id="compile" class="btn primary">Compile & Download</button>
    </div>
  </div>
</header>

<main>
  <aside class="card">
    <div style="font-weight:800">Sheets</div>
    <div id="tabs"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="newSheet" class="btn">+ New</button>
      <button id="renameSheet" class="btn">Rename</button>
      <button id="deleteSheet" class="btn">Delete</button>
    </div>

    <div style="font-weight:800;margin-top:14px;">Blocks</div>
    <div style="font-size:13px;color:#64748b">Click to add</div>
    <div class="block" data-type="table">üìã Table</div>
    <div class="block" data-type="chart">üìä Chart</div>
    <div class="block" data-type="kpi">üéØ KPI</div>
    <div class="block" data-type="form">üìù Form</div>
    <div class="block" data-type="button">üîò Button</div>

    <div style="font-weight:800;margin-top:14px;">Workbook Settings</div>
    <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
      <input type="checkbox" id="smartSave"> Enable Smart Save-As (.xlsm)
    </label>
    <div id="smartFields" style="display:none;">
      <div style="font-size:13px;color:#64748b">Base name</div>
      <input id="baseName" value="Report_" style="width:100%;border:1px solid var(--border);border-radius:8px;padding:6px 8px;">
      <div style="font-size:13px;color:#64748b;margin-top:6px;">Date format</div>
      <input id="dateFmt" value="yyyy-mm-dd" style="width:100%;border:1px solid var(--border);border-radius:8px;padding:6px 8px;">
      <label style="display:flex;align-items:center;gap:8px;margin-top:6px;">
        <input type="checkbox" id="reqCopy" checked> Require new copy on open
      </label>
    </div>
  </aside>

  <section class="card" style="display:flex;flex-direction:column;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <button id="modeGrid" class="btn">Grid</button>
      <button id="modeCanvas" class="btn">Canvas</button>
      <div style="font-size:13px;color:#64748b">Drag to move, corner to resize</div>
    </div>
    <div class="stage">
      <div id="gridWrap" class="gridwrap">
        <div class="cells" id="cells"></div>
        <div id="gridWidgets"></div>
      </div>
      <div id="canvasWrap" class="gridwrap" style="display:none;">
        <div class="canvas" id="canvas"></div>
      </div>
    </div>
    <div class="footer">
      <div style="font-size:13px;color:#64748b">Try commands: ‚Äúadd chart‚Äù ‚Ä¢ ‚Äúauto layout‚Äù</div>
      <input id="cmd" class="inp" placeholder="Describe a change‚Ä¶">
      <button id="apply" class="btn">Apply</button>
    </div>
  </section>

  <aside class="card">
    <div style="font-weight:800">Properties</div>
    <div style="font-size:13px;color:#64748b" id="propHint">Select a block to edit.</div>
    <div id="props" style="display:none;">
      <div style="font-size:13px;color:#64748b">Title</div><input id="pTitle" style="width:100%;border:1px solid var(--border);border-radius:8px;padding:6px 8px;">
      <div style="font-size:13px;color:#64748b;margin-top:6px;">Subtitle</div><input id="pSub" style="width:100%;border:1px solid var(--border);border-radius:8px;padding:6px 8px;">
      <div style="font-size:13px;color:#64748b;margin-top:6px;">X Y W H</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;">
        <input id="pX"><input id="pY"><input id="pW"><input id="pH">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="pApply" class="btn">Apply</button>
        <button id="pDelete" class="btn">Delete</button>
      </div>
    </div>
  </aside>
</main>

<script>
(function(){
  const size=40, rows=24, cols=36;
  let seq=1, selectedId=null;
  let sheets=[{name:'Dashboard', widgets:[{id:seq++, type:'chart', title:'Revenue by Month', sub:'', x:2,y:2,w:18,h:10},{id:seq++, type:'kpi', title:'Total Revenue', sub:'', x:2,y:14,w:8,h:6}]},{name:'Data', widgets:[]}];
  let active=0;

  const $=s=>document.querySelector(s);
  const $$=s=>Array.from(document.querySelectorAll(s));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const current=()=>sheets[active];

  function buildGrid(){
    const cells=$("#cells"); cells.innerHTML='';
    for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const d=document.createElement('div'); d.className='cell'; cells.appendChild(d); } }
  }
  function renderTabs(){
    const tabs=$("#tabs"); tabs.innerHTML='';
    sheets.forEach((s,i)=>{
      const el=document.createElement('span'); el.className='tab'+(i===active?' active':''); el.textContent=s.name;
      el.onclick=()=>{ active=i; selectedId=null; renderAll(false); };
      tabs.appendChild(el);
    });
  }
  function widgetEl(w){
    const el=document.createElement('div'); el.className='widget'+(w.id===selectedId?' sel':''); el.style.left=(w.x*size)+'px'; el.style.top=(w.y*size)+'px'; el.style.width=(w.w*size)+'px'; el.style.height=(w.h*size)+'px';
    const t=document.createElement('div'); t.className='ttl'; t.textContent=w.title||w.type;
    const s=document.createElement('div'); s.className='sub'; s.textContent=w.sub||'';
    const b=document.createElement('div'); b.className='box';
    const h=document.createElement('div'); h.className='handle';
    el.appendChild(t); el.appendChild(s); el.appendChild(b); el.appendChild(h);
    el.addEventListener('mousedown', (e)=>{ if(e.target===h) return; selectedId=w.id; renderProps(); e.stopPropagation(); });

    // drag
    el.addEventListener('mousedown', (e)=>{
      if(e.target===h) return;
      const start={mx:e.clientX,my:e.clientY,x:w.x,y:w.y};
      const mm=(ev)=>{ const dx=Math.round((ev.clientX-start.mx)/size), dy=Math.round((ev.clientY-start.my)/size);
        w.x=clamp(start.x+dx,1,cols-1); w.y=clamp(start.y+dy,1,rows-1); renderAll(false); };
      const up=()=>{ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up); };
      document.addEventListener('mousemove',mm); document.addEventListener('mouseup',up);
    });
    // resize
    h.addEventListener('mousedown', (e)=>{
      e.stopPropagation();
      const start={mx:e.clientX,my:e.clientY,w:w.w,h:w.h};
      const mm=(ev)=>{ const dx=Math.round((ev.clientX-start.mx)/size), dy=Math.round((ev.clientY-start.my)/size);
        w.w=clamp(start.w+dx,2,cols-w.x); w.h=clamp(start.h+dy,2,rows-w.y); renderAll(false); };
      const up=()=>{ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up); };
      document.addEventListener('mousemove',mm); document.addEventListener('mouseup',up);
    });
    return el;
  }
  function renderWidgets(){
    const gridHost=$("#gridWidgets"); gridHost.innerHTML='';
    const canvasHost=$("#canvas"); canvasHost.innerHTML='';
    current().widgets.forEach(w=>{ gridHost.appendChild(widgetEl(w)); canvasHost.appendChild(widgetEl(w)); });
  }
  function renderProps(){
    const box=$("#props"), hint=$("#propHint");
    if(!selectedId){ box.style.display='none'; hint.textContent='Select a block to edit.'; return; }
    const w=current().widgets.find(x=>x.id===selectedId); box.style.display='block'; hint.textContent='Editing '+(w.title||w.type);
    $("#pTitle").value=w.title||''; $("#pSub").value=w.sub||''; $("#pX").value=w.x; $("#pY").value=w.y; $("#pW").value=w.w; $("#pH").value=w.h;
  }
  function renderAll(rebuildGrid=true){ if(rebuildGrid) buildGrid(); renderTabs(); renderWidgets(); renderProps(); }

  // events
  $$(".block").forEach(b=> b.addEventListener('click',()=>{ const type=b.getAttribute('data-type');
    const presets={table:[2,14,14,8,'Table'],chart:[2,2,18,10,'Chart'],kpi:[22,2,8,6,'KPI'],form:[22,10,12,8,'Form'],button:[20,6,8,5,'Button']};
    const d=presets[type]||[2,2,8,6,type];
    const w={id:seq++, type, x:d[0],y:d[1],w:d[2],h:d[3], title:d[4]}; current().widgets.push(w); selectedId=w.id; renderAll(false);
  }));
  $("#newSheet").onclick=()=>{ sheets.push({name:'Sheet '+(sheets.length+1), widgets:[]}); active=sheets.length-1; renderAll(false); };
  $("#renameSheet").onclick=()=>{ const nm=prompt('New name', sheets[active].name); if(nm){ sheets[active].name=nm; renderAll(false);} };
  $("#deleteSheet").onclick=()=>{ if(sheets.length<=1) return alert('Keep at least 1'); sheets.splice(active,1); active=0; selectedId=null; renderAll(false); };
  $("#modeGrid").onclick=()=>{ $("#gridWrap").style.display='block'; $("#canvasWrap").style.display='none'; };
  $("#modeCanvas").onclick=()=>{ $("#gridWrap").style.display='none'; $("#canvasWrap").style.display='block'; };
  $("#pApply").onclick=()=>{ if(!selectedId) return; const w=current().widgets.find(x=>x.id===selectedId);
    w.title=$("#pTitle").value; w.sub=$("#pSub").value; w.x=parseInt($("#pX").value||w.x); w.y=parseInt($("#pY").value||w.y);
    w.w=parseInt($("#pW").value||w.w); w.h=parseInt($("#pH").value||w.h); renderAll(false); };
  $("#pDelete").onclick=()=>{ if(!selectedId) return; const arr=current().widgets; const i=arr.findIndex(x=>x.id===selectedId); if(i>-1) arr.splice(i,1); selectedId=null; renderAll(false); };
  $("#gridWrap").addEventListener('mousedown', (e)=>{ if(e.target.id==='gridWrap') {selectedId=null; renderProps();} });
  $("#canvasWrap").addEventListener('mousedown', (e)=>{ if(e.target.id==='canvas') {selectedId=null; renderProps();} });

  $("#smartSave").onchange=()=>{ $("#smartFields").style.display = $("#smartSave").checked? 'block':'none'; };

  $("#apply").onclick=()=>{ const t=$("#cmd").value.trim().toLowerCase();
    if(t.includes("add") && t.includes("chart")) { $$(".block[data-type='chart']")[0].click(); }
    else if(t.includes("add") && t.includes("table")) { $$(".block[data-type='table']")[0].click(); }
    else if(t.includes("auto")) { current().widgets.forEach((w,i)=>{ w.x = (i%2===0)?2:20; w.y = 2 + Math.floor(i/2)*10; w.w = (i%2===0)?16:14; w.h = 8; }); renderAll(false); }
    else { alert("Try: add chart ‚Ä¢ add table ‚Ä¢ auto layout"); }
    $("#cmd").value='';
  };

  // compile & download via backend on same host
  $("#compile").onclick=async()=>{
    const payload={
      project: $("#projectName").value || "Workbook",
      sheets,
      settings: {
        enabled: $("#smartSave").checked,
        baseName: $("#baseName")?.value || "Report_",
        dateFormat: $("#dateFmt")?.value || "yyyy-mm-dd",
        requireCopyOnOpen: $("#reqCopy")?.checked ?? true,
        templateTag: "TEMPLATE",
        sequenceIfExists: true
      }
    };
    const res = await fetch('/api/compile', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok){ alert('Compile failed'); return; }
    const blob = await res.blob();
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = (payload.project || 'Workbook').replace(/\s+/g,'_') + '.xlsx';
    a.click();
  };

  renderAll(true);
})();
</script>
</body>
</html>
