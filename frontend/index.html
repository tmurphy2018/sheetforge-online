<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SheetForge – Visual Builder</title>
<style>
  :root{--bg:#ffffff;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--ok:#10b981;--accent:#2563eb}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border)}
  .wrap{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 16px}
  .btn{padding:8px 10px;border:1px solid var(--border);background:#fff;border-radius:10px;font-weight:600;cursor:pointer;transition:opacity .15s ease}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.primary{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.accent{background:var(--accent);border-color:var(--accent);color:#fff}
  main{display:grid;grid-template-columns:320px 1fr 380px;gap:12px;padding:12px;height:calc(100vh - 64px)}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .tabsbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tab{padding:6px 10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
  .tab.active{outline:2px solid var(--accent)}
  .stage{position:relative;height:100%;border:1px solid var(--border);border-radius:12px;overflow:auto;background:#fff}
  .gridwrap{position:relative;padding:16px}
  .page{position:relative;margin:24px auto;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 18px rgba(0,0,0,0.06)}
  .page-inner{position:absolute;inset:0}
  .page-margins{position:absolute;inset:0;pointer-events:none;outline:1px dashed #d1d5db}
  .widget{position:absolute;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06);padding:8px;user-select:none}
  .widget.sel{outline:2px solid var(--accent)}
  .ttl[contenteditable], .sub[contenteditable]{outline:none; border-radius:6px}
  .ttl[contenteditable]:focus, .sub[contenteditable]:focus{box-shadow:inset 0 0 0 2px #dbeafe}
  .ttl{font-weight:800;font-size:13px}
  .sub{font-size:12px;color:#64748b}
  .box{margin-top:6px;border:1px dashed var(--border);border-radius:10px;min-height:36px}
  .handle{position:absolute;width:12px;height:12px;background:#111;border-radius:3px;right:-6px;bottom:-6px;cursor:nwse-resize}
  .inp{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px}
  .row{display:flex;gap:8px;align-items:center}
  .hint{font-size:13px;color:#64748b}
  .chip{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin-right:6px;margin-top:6px;cursor:pointer;background:#fff}
  table.sf-mini{border-collapse:separate;border-spacing:0;width:100%;font-size:12px}
  table.sf-mini th, table.sf-mini td{border:1px solid #e5e7eb;padding:6px 8px}
  table.sf-mini th{background:#f8fafc;text-align:left}
  .cell-sel{outline:2px solid var(--accent);outline-offset:-2px}
  /* Context menu */
  .ctx{position:fixed;z-index:1000;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 24px rgba(0,0,0,.12);min-width:220px;overflow:hidden}
  .ctx-item{padding:10px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;font-size:14px}
  .ctx-item:hover{background:#f8fafc}
  .ctx-sep{height:1px;background:#eef2f7;margin:4px 0}
  .pill{border:1px solid var(--border);border-radius:999px;padding:6px 8px}
  .sec-title{font-weight:800;margin-top:10px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="display:flex;align-items:center;gap:10px;">
      <div style="width:36px;height:36px;border-radius:10px;background:#111;color:#fff;display:grid;place-items:center;font-weight:800">SF</div>
      <div>
        <div style="font-weight:800">SheetForge Visual Builder</div>
        <div class="hint">Canvas • Multi-sheet • AI Assistant</div>
      </div>
    </div>
    <div class="row">
      <input id="projectName" value="Untitled Workbook" style="border:1px solid var(--border);border-radius:8px;padding:6px 8px;">
      <button id="compile" class="btn primary">Compile & Download</button>
      <button id="deleteSel" class="btn" disabled>Delete Selected</button>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: Blocks, Page Setup, Workbook Settings -->
  <aside class="card">
    <div style="font-weight:800">Blocks</div>
    <div class="hint">Click to add</div>
    <div class="block" data-type="table">📋 Table</div>
    <div class="block" data-type="chart">📊 Chart</div>
    <div class="block" data-type="kpi">🎯 KPI</div>
    <div class="block" data-type="button">🔘 Button</div>

    <div class="sec-title">Page Setup</div>
    <div class="row">
      <label class="hint" style="width:92px;">Size</label>
      <select id="pageSize" class="inp" style="padding:6px 8px;">
        <option value="Letter" selected>Letter (8.5×11)</option>
        <option value="Legal">Legal (8.5×14)</option>
        <option value="A4">A4 (210×297)</option>
        <option value="A3">A3 (297×420)</option>
      </select>
    </div>
    <div class="row" style="margin-top:6px;">
      <label class="hint" style="width:92px;">Orientation</label>
      <select id="orientation" class="inp" style="padding:6px 8px;">
        <option value="portrait" selected>Portrait</option>
        <option value="landscape">Landscape</option>
      </select>
    </div>
    <div class="row" style="margin-top:6px;">
      <label class="hint" style="width:92px;">Margins</label>
      <input id="mTop" type="number" value="40" style="width:64px" class="inp">
      <input id="mRight" type="number" value="40" style="width:64px" class="inp">
      <input id="mBottom" type="number" value="40" style="width:64px" class="inp">
      <input id="mLeft" type="number" value="40" style="width:64px" class="inp">
    </div>

    <div class="sec-title">Workbook Settings</div>
    <label class="row" style="margin-top:6px;">
      <input type="checkbox" id="smartSave"> <span>Enable Smart Save-As (.xlsm)</span>
    </label>
    <div id="smartFields" style="display:none;">
      <div class="hint">Base name</div>
      <input id="baseName" value="Report_" class="inp">
      <div class="hint" style="margin-top:6px;">Date format</div>
      <input id="dateFmt" value="yyyy-mm-dd" class="inp">
      <label class="row" style="margin-top:6px;">
        <input type="checkbox" id="reqCopy" checked> <span>Require new copy on open</span>
      </label>
    </div>
  </aside>

  <!-- CENTER: Sheet Tabs + Canvas -->
  <section class="card" style="display:flex;flex-direction:column;">
    <div>
      <div style="font-weight:800;margin-bottom:6px;">Sheets</div>
      <div id="tabs" class="tabsbar"></div>
    </div>

    <div class="row" style="margin:8px 0;">
      <button id="newSheet" class="btn">+ New</button>
      <button id="renameSheet" class="btn">Rename</button>
      <button id="deleteSheet" class="btn">Delete</button>
      <div class="hint" style="margin-left:auto;">Drag • Resize • Right-click for menu • Click title to edit</div>
    </div>

    <div class="stage">
      <div id="canvasWrap" class="gridwrap">
        <div id="page" class="page" style="width:816px;height:1056px;">
          <div id="pageInner" class="page-inner"></div>
          <div id="pageMargins" class="page-margins"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: AI + Context Properties -->
  <aside class="card" id="rightPanel">
    <div style="font-weight:800">AI Assistant</div>
    <div class="hint">Examples (work on selected block):</div>
    <div class="chip" data-ai="rename table to SalesData">rename table to SalesData</div>
    <div class="chip" data-ai="format column Amount as currency">format column Amount as currency</div>
    <div class="chip" data-ai="add total row">add total row</div>
    <div class="chip" data-ai="sum Amount into KPI">sum Amount into KPI</div>

    <textarea id="aiText" class="inp" style="margin-top:8px;height:90px;" placeholder="e.g., format column Date as mm/dd/yyyy"></textarea>
    <div class="row">
      <button id="aiSuggest" class="btn accent">Apply</button>
    </div>

    <div id="aiResult" style="display:none;margin-top:10px;border:1px solid var(--border);border-radius:10px;padding:10px;">
      <div style="font-weight:700;">What I did</div>
      <div id="aiExplain" class="hint"></div>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)">

    <div style="font-weight:800">Properties</div>
    <div class="hint" id="propHint">Select a block to edit.</div>

    <!-- Common -->
    <div id="propsCommon" style="display:none;">
      <div class="hint">Title</div><input id="pTitle" class="inp">
      <div class="hint" style="margin-top:6px;">Subtitle</div><input id="pSub" class="inp">
      <div class="hint" style="margin-top:6px;">X Y W H</div>
      <div class="row">
        <input id="pX" class="inp" style="width:72px"><input id="pY" class="inp" style="width:72px"><input id="pW" class="inp" style="width:72px"><input id="pH" class="inp" style="width:72px">
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="pApply" class="btn">Apply</button>
        <button id="pDelete" class="btn">Delete</button>
      </div>
    </div>

    <!-- Table props -->
    <div id="propsTable" style="display:none;">
      <div class="sec-title">Table</div>
      <div class="hint">Name</div><input id="tName" class="inp" placeholder="e.g., SalesData">
      <div class="hint" style="margin-top:6px;">Columns (comma-separated)</div><input id="tCols" class="inp" placeholder="Date, Item, Amount, Status">
      <div class="hint" style="margin-top:6px;">Selected Cell</div>
      <div class="row">
        <input id="cellRef" class="inp" placeholder="Row,Col e.g. 2,3">
        <select id="cellFmt" class="inp" style="max-width:170px">
          <option value="">(no change)</option>
          <option value="currency">$ Currency</option>
          <option value="number2">Number (2 dp)</option>
          <option value="date">Date (mm/dd/yyyy)</option>
          <option value="text">Text</option>
          <option value="upper">UPPERCASE</option>
          <option value="proper">Capitalize Words</option>
        </select>
      </div>
      <div class="row" style="margin-top:6px;">
        <button id="applyCellFmt" class="btn">Apply Cell Format</button>
        <button id="addTotalRow" class="btn">Add Total Row</button>
      </div>
    </div>

    <!-- Chart props -->
    <div id="propsChart" style="display:none;">
      <div class="sec-title">Chart</div>
      <div class="hint">Chart Type</div>
      <select id="cType" class="inp">
        <option value="bar">Bar</option>
        <option value="line">Line</option>
        <option value="pie">Pie</option>
      </select>
    </div>

    <!-- KPI props -->
    <div id="propsKPI" style="display:none;">
      <div class="sec-title">KPI</div>
      <div class="hint">Value (preview)</div>
      <input id="kValue" class="inp" placeholder="e.g., 12345">
    </div>
  </aside>
</main>

<!-- App Context Menu -->
<div id="ctx" class="ctx" style="display:none;">
  <div class="ctx-item" data-act="add-table">📋 Add Table</div>
  <div class="ctx-item" data-act="add-chart">📊 Add Chart</div>
  <div class="ctx-item" data-act="add-kpi">🎯 Add KPI</div>
  <div class="ctx-item" data-act="add-button">🔘 Add Button</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-act="auto-layout">✨ Auto Layout</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-act="duplicate">📑 Duplicate Selected</div>
  <div class="ctx-item" data-act="delete">🗑️ Delete Selected</div>
</div>

<script>
(function(){
  // === Layout & page constants ===
  const size=40, rows=24, cols=36;
  const PAPER_SIZES = { Letter:{w:816,h:1056}, Legal:{w:816,h:1344}, A4:{w:794,h:1123}, A3:{w:1123,h:1587} };

  // === State ===
  let seq=1, selectedId=null, selectedCell=null; // selectedCell: {r,c} only for table
  let page = { size:'Letter', orientation:'portrait', margin:{top:40,right:40,bottom:40,left:40} };
  // add table model defaults: columns, data, name, formats
  let sheets=[{name:'Dashboard', widgets:[
    {id:seq++, type:'chart', title:'Revenue by Month', sub:'', x:2,y:2,w:18,h:10, chartType:'bar'},
    {id:seq++, type:'kpi', title:'Total Revenue', sub:'', x:22,y:2,w:8,h:6, value:123456}
  ]},{name:'Data', widgets:[]}];
  let active=0;

  // === Shortcuts ===
  const $=s=>document.querySelector(s);
  const $$=s=>Array.from(document.querySelectorAll(s));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const current=()=>sheets[active];

  // === Page sizing ===
  function dims(){
    const base = PAPER_SIZES[page.size] || PAPER_SIZES.Letter;
    return page.orientation==='portrait' ? {w:base.w,h:base.h} : {w:base.h,h:base.w};
  }
  function renderPageFrame(){
    const {w,h}=dims();
    const pageEl = $("#page");
    pageEl.style.width = w+"px";
    pageEl.style.height = h+"px";
    const m = page.margin;
    $("#pageInner").style.left = m.left+"px";
    $("#pageInner").style.right = m.right+"px";
    $("#pageInner").style.top = m.top+"px";
    $("#pageInner").style.bottom = m.bottom+"px";
    $("#pageMargins").style.left = m.left+"px";
    $("#pageMargins").style.right = m.right+"px";
    $("#pageMargins").style.top = m.top+"px";
    $("#pageMargins").style.bottom = m.bottom+"px";
  }

  // === Tabs at top of canvas ===
  function renderTabs(){
    const tabs=$("#tabs"); tabs.innerHTML='';
    sheets.forEach((s,i)=>{
      const el=document.createElement('span'); el.className='tab'+(i===active?' active':''); el.textContent=s.name;
      el.onclick=()=>{ active=i; setSelected(null); renderAll(); };
      tabs.appendChild(el);
    });
  }

  // === Selection helpers ===
  function setSelected(id){
    selectedId = id; selectedCell=null;
    renderProps(); updateDeleteButton(); renderWidgetsOnly();
  }
  function updateDeleteButton(){ $("#deleteSel").disabled = !selectedId; }

  // === Auto Layout (simple 2-col within margins) ===
  function autoLayout(){
    const m = page.margin;
    const colWidthCells = Math.floor((dims().w - m.left - m.right) / size);
    const mid = Math.floor(colWidthCells/2);
    let yLeft=1, yRight=1;
    current().widgets.forEach((w,i)=>{
      const left = i%2===0;
      w.x = left ? 1 : mid + 2;
      w.w = left ? mid - 2 : colWidthCells - (mid + 3);
      w.h = (w.type==='chart') ? 10 : 8;
      w.y = left ? yLeft : yRight;
      if(left) yLeft += w.h + 2; else yRight += w.h + 2;
    });
    renderAll();
  }

  // === Widget DOM ===
  function widgetEl(w){
    const host = $("#pageInner");
    const el=document.createElement('div');
    el.className='widget'+(w.id===selectedId?' sel':'');
    el.dataset.wid = String(w.id);
    el.style.left=(w.x*size)+'px'; el.style.top=(w.y*size)+'px'; el.style.width=(w.w*size)+'px'; el.style.height=(w.h*size)+'px';

    // header
    const t=document.createElement('div'); t.className='ttl'; t.textContent=w.title||w.type; t.contentEditable="true";
    const s=document.createElement('div'); s.className='sub'; s.textContent=w.sub||''; s.contentEditable="true";
    t.addEventListener('input',()=>{ w.title=t.textContent; syncPropsCommon(w); });
    s.addEventListener('input',()=>{ w.sub=s.textContent; syncPropsCommon(w); });

    // body
    const body=document.createElement('div'); body.className='box'; body.style.height='calc(100% - 36px)';

    if(w.type==='table'){
      // ensure model
      w.name = w.name || 'Table1';
      w.columns = w.columns || ['Date','Item','Amount','Status'];
      w.data = w.data || [
        ['1/1/2025','Widget',1200,'Paid'],
        ['1/2/2025','Gadget',300,'Open'],
        ['1/3/2025','Service',450,'Paid']
      ];
      w.formats = w.formats || {}; // e.g., {"Amount":"currency"}
      const tbl = document.createElement('table'); tbl.className='sf-mini';
      const thead=document.createElement('thead'); const trh=document.createElement('tr');
      w.columns.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; trh.appendChild(th); });
      thead.appendChild(trh); tbl.appendChild(thead);
      const tbody=document.createElement('tbody');
      w.data.forEach((row,ri)=>{
        const tr=document.createElement('tr');
        row.forEach((val,ci)=>{
          const td=document.createElement('td'); td.textContent=val;
          td.addEventListener('mousedown',(e)=>{ e.stopPropagation(); setSelected(w.id); selectedCell={r:ri+1,c:ci+1}; highlightCell(tbl, ri, ci); showTableCellRef(ri+1,ci+1); });
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);
      body.appendChild(tbl);
    }
    else if(w.type==='chart'){
      body.innerHTML = `<div class="hint" style="padding:8px;">${(w.chartType||'bar').toUpperCase()} chart preview (Excel will render)</div>`;
    }
    else if(w.type==='kpi'){
      const val = (w.value != null)? w.value : 12345;
      body.innerHTML = `<div style="padding:8px;font-size:28px;font-weight:800;">${val}</div>`;
    }
    else if(w.type==='button'){
      body.innerHTML = `<button class="btn">Run</button>`;
    }

    const h=document.createElement('div'); h.className='handle';

    el.appendChild(t); el.appendChild(s); el.appendChild(body); el.appendChild(h);

    // select
    el.addEventListener('mousedown', (e)=>{ if(e.target===h) return; setSelected(w.id); e.stopPropagation(); });

    // drag
    el.addEventListener('mousedown', (e)=>{
      if(e.target===h) return;
      const start={mx:e.clientX,my:e.clientY,x:w.x,y:w.y};
      const mm=(ev)=>{ const dx=Math.round((ev.clientX-start.mx)/size), dy=Math.round((ev.clientY-start.my)/size);
        w.x=clamp(start.x+dx,1,cols-1); w.y=clamp(start.y+dy,1,rows-1); renderWidgetsOnly(); renderProps(); };
      const up=()=>{ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up); };
      document.addEventListener('mousemove',mm); document.addEventListener('mouseup',up);
    });

    // resize
    h.addEventListener('mousedown', (e)=>{
      e.stopPropagation();
      const start={mx:e.clientX,my:e.clientY,w:w.w,h:w.h};
      const mm=(ev)=>{ const dx=Math.round((ev.clientX-start.mx)/size), dy=Math.round((ev.clientY-start.my)/size);
        w.w=clamp(start.w+dx,2,cols-w.x); w.h=clamp(start.h+dy,2,rows-w.y); renderWidgetsOnly(); };
      const up=()=>{ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up); };
      document.addEventListener('mousemove',mm); document.addEventListener('mouseup',up);
    });

    $("#pageInner").appendChild(el); return el;
  }

  function highlightCell(tbl, r, c){
    tbl.querySelectorAll('td').forEach(td=>td.classList.remove('cell-sel'));
    const row = tbl.querySelectorAll('tbody tr')[r];
    if(!row) return;
    const cell = row.children[c];
    if(cell) cell.classList.add('cell-sel');
  }

  function showTableCellRef(r,c){
    $("#cellRef").value = `${r},${c}`;
  }

  function renderWidgetsOnly(){
    $("#pageInner").innerHTML='';
    current().widgets.forEach(w=> widgetEl(w));
    if(selectedId){
      const node = document.querySelector(`[data-wid="${selectedId}"]`);
      if(node) node.classList.add('sel');
    }
  }

  // === Properties ===
  function syncPropsCommon(w){
    $("#pTitle").value=w.title||''; $("#pSub").value=w.sub||'';
  }

  function renderProps(){
    const hint=$("#propHint");
    const show=(id, show)=>{ const el=$(id); if(el) el.style.display = show? 'block':'none'; };
    const common = $("#propsCommon");
    const pTable = $("#propsTable");
    const pChart = $("#propsChart");
    const pKPI = $("#propsKPI");

    if(!selectedId){ hint.textContent='Select a block to edit.'; [common,pTable,pChart,pKPI].forEach(x=>x.style.display='none'); return; }

    const w=current().widgets.find(x=>x.id===selectedId);
    hint.textContent = 'Editing ' + (w.title||w.type);

    // common
    common.style.display='block';
    $("#pTitle").value=w.title||''; $("#pSub").value=w.sub||''; $("#pX").value=w.x; $("#pY").value=w.y; $("#pW").value=w.w; $("#pH").value=w.h;

    // type-specific
    pTable.style.display = (w.type==='table')?'block':'none';
    pChart.style.display = (w.type==='chart')?'block':'none';
    pKPI.style.display   = (w.type==='kpi')  ?'block':'none';

    if(w.type==='table'){
      $("#tName").value = w.name || 'Table1';
      $("#tCols").value = (w.columns || []).join(', ');
    } else if(w.type==='chart'){
      $("#cType").value = w.chartType || 'bar';
    } else if(w.type==='kpi'){
      $("#kValue").value = w.value != null ? w.value : '';
    }
  }

  function renderAll(){ renderPageFrame(); renderTabs(); renderWidgetsOnly(); renderProps(); }

  // === AI actions (simple interpreter) ===
  function aiApply(text){
    if(!selectedId){ $("#aiResult").style.display='block'; $("#aiExplain").textContent = "Select a block first."; return; }
    const w=current().widgets.find(x=>x.id===selectedId); if(!w) return;

    let did = "";

    // Rename table
    let m = text.match(/rename table to\s+([A-Za-z0-9_]+)/i);
    if(m && w.type==='table'){
      w.name = m[1]; did = `Table renamed to ${w.name}.`;
    }

    // Format column X as currency/number/date/text
    m = text.match(/format column\s+([A-Za-z0-9_ ]+)\s+as\s+(currency|number|number with 2 decimals|date|text)/i);
    if(m && w.type==='table'){
      const col = m[1].trim(); const fmt = m[2].toLowerCase();
      w.formats = w.formats || {};
      const key = (fmt.includes('currency'))?'currency':(fmt.includes('2')?'number2':(fmt.includes('date')?'date':(fmt.includes('text')?'text':'number')));
      w.formats[col]=key;
      did = `Column "${col}" formatted as ${key}.`;
    }

    // Add total row
    m = text.match(/add total row/i);
    if(m && w.type==='table'){
      // append a total row (SUM of numeric columns)
      const numsIdx = (w.columns||[]).map((c,ci)=>({c,ci})).filter(o=>['Amount','Total','Value','Price','Cost'].includes(o.c));
      const row = new Array(w.columns.length).fill('');
      if(numsIdx.length){
        numsIdx.forEach(o=>{
          const sum = (w.data||[]).reduce((a,r)=> a + (parseFloat(r[o.ci])||0), 0);
          row[o.ci] = sum;
        });
      }
      row[0] = 'Total';
      w.data = w.data || [];
      w.data.push(row);
      did = "Total row added.";
    }

    // sum Amount into KPI
    m = text.match(/sum\s+([A-Za-z0-9_ ]+)\s+into\s+KPI/i);
    if(m){
      const col = m[1].trim();
      // find a table on the same sheet
      const tbl = current().widgets.find(x=>x.type==='table');
      const kpi = (w.type==='kpi')? w : current().widgets.find(x=>x.type==='kpi');
      if(tbl && kpi){
        const idx = (tbl.columns||[]).findIndex(c=>c.toLowerCase()===col.toLowerCase());
        if(idx>=0){
          const sum = (tbl.data||[]).reduce((a,r)=> a + (parseFloat(r[idx])||0), 0);
          kpi.value = sum; did = `KPI set to SUM of ${col} = ${sum}.`;
        }
      }
    }

    if(!did) did = "No matching AI action recognized.";
    $("#aiResult").style.display='block';
    $("#aiExplain").textContent = did;
    renderAll();
  }

  // === EVENTS ===

  // Blocks
  $$(".block").forEach(b=> b.addEventListener('click',()=>{ const type=b.getAttribute('data-type');
    const presets={table:[2,12,18,10,'Table'],chart:[2,2,18,10,'Chart'],kpi:[22,2,8,6,'KPI'],button:[20,10,8,5,'Button']};
    const d=presets[type]||[2,2,8,6,type];
    const w={id:seq++, type, x:d[0],y:d[1],w:d[2],h:d[3], title:d[4]};
    if(type==='table'){ w.name='Table'+seq; w.columns=['Date','Item','Amount','Status']; w.data=[['1/1/2025','Item',100,'Open']]; w.formats={}; }
    if(type==='chart'){ w.chartType='bar'; }
    if(type==='kpi'){ w.value=0; }
    current().widgets.push(w); setSelected(w.id); renderAll();
  }));

  // Sheets
  $("#newSheet").onclick=()=>{ sheets.push({name:'Sheet '+(sheets.length+1), widgets:[]}); active=sheets.length-1; setSelected(null); renderAll(); };
  $("#renameSheet").onclick=()=>{ const nm=prompt('New name', sheets[active].name); if(nm){ sheets[active].name=nm; renderAll();} };
  $("#deleteSheet").onclick=()=>{ if(sheets.length<=1) return alert('Keep at least 1'); sheets.splice(active,1); active=0; setSelected(null); renderAll(); };

  // Deselect on empty canvas
  $("#canvasWrap").addEventListener('mousedown', (e)=>{ 
    const ids = ['page','pageInner','pageMargins'];
    if(ids.includes(e.target.id)) { setSelected(null); renderWidgetsOnly(); }
  });

  // Properties (common)
  $("#pApply").onclick=()=>{ if(!selectedId) return; const w=current().widgets.find(x=>x.id===selectedId);
    w.title=$("#pTitle").value; w.sub=$("#pSub").value; w.x=parseInt($("#pX").value||w.x); w.y=parseInt($("#pY").value||w.y);
    w.w=parseInt($("#pW").value||w.w); w.h=parseInt($("#pH").value||w.h); renderAll(); };
  $("#pDelete").onclick=()=>{ if(!selectedId) return; const arr=current().widgets; const i=arr.findIndex(x=>x.id===selectedId); if(i>-1) arr.splice(i,1); setSelected(null); renderAll(); };

  // Table props
  $("#applyCellFmt").onclick=()=>{ if(!selectedId) return; const w=current().widgets.find(x=>x.id===selectedId);
    if(w.type!=='table') return;
    // parse ref
    const rc = $("#cellRef").value.trim().split(',');
    const r = parseInt(rc[0]), c=parseInt(rc[1]);
    if(!(r>0&&c>0)) return alert('Enter Row,Col like 2,3');
    const fmt = $("#cellFmt").value;
    // store per-cell fmt
    w.cellFmt = w.cellFmt || {};
    w.cellFmt[`${r},${c}`]=fmt;
    renderAll();
  };
  $("#addTotalRow").onclick=()=> aiApply('add total row');

  // Chart props
  $("#cType").onchange=()=>{ if(!selectedId) return; const w=current().widgets.find(x=>x.id===selectedId); if(w.type!=='chart') return; w.chartType=$("#cType").value; renderAll(); };

  // KPI props
  $("#kValue").onchange=()=>{ if(!selectedId) return; const w=current().widgets.find(x=>x.id===selectedId); if(w.type!=='kpi') return; w.value = parseFloat($("#kValue").value || 0); renderAll(); };

  // Delete Selected button
  $("#deleteSel").onclick=()=>{ if(selectedId) $("#pDelete").click(); };

  // Delete key — only when a block is selected and you're NOT typing
  window.addEventListener('keydown', (e) => {
    if (!selectedId) return;
    const tag = (document.activeElement?.tagName || '').toUpperCase();
    if (tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable) return;
    if (e.key === 'Delete' || e.key === 'Backspace') {
      e.preventDefault();
      $("#pDelete").click();
    }
  });

  // Page setup
  $("#pageSize").onchange=()=>{ page.size = $("#pageSize").value; renderPageFrame(); };
  $("#orientation").onchange=()=>{ page.orientation = $("#orientation").value; renderPageFrame(); };
  $("#mTop").onchange=()=>{ page.margin.top = parseInt($("#mTop").value||0); renderPageFrame(); };
  $("#mRight").onchange=()=>{ page.margin.right = parseInt($("#mRight").value||0); renderPageFrame(); };
  $("#mBottom").onchange=()=>{ page.margin.bottom = parseInt($("#mBottom").value||0); renderPageFrame(); };
  $("#mLeft").onchange=()=>{ page.margin.left = parseInt($("#mLeft").value||0); renderPageFrame(); };

  // Smart save toggle
  $("#smartSave").onchange=()=>{ $("#smartFields").style.display = $("#smartSave").checked? 'block':'none'; };

  // AI chips & button
  $$(".chip").forEach(c=> c.addEventListener('click',()=>{ $("#aiText").value = c.getAttribute('data-ai'); }));
  $("#aiSuggest").onclick=()=>{ const t=$("#aiText").value.trim(); if(!t) return; aiApply(t); };

  // Context menu
  const ctx = $("#ctx");
  function openCtx(x,y){
    ctx.style.display='block';
    const vw=window.innerWidth, vh=window.innerHeight, cw=ctx.offsetWidth, ch=ctx.offsetHeight;
    ctx.style.left = Math.min(x, vw-cw-8) + 'px';
    ctx.style.top  = Math.min(y, vh-ch-8) + 'px';
  }
  function closeCtx(){ ctx.style.display='none'; }
  function duplicateSelected(){
    if(!selectedId) return;
    const w = current().widgets.find(x=>x.id===selectedId);
    if(!w) return;
    const copy = JSON.parse(JSON.stringify(w));
    copy.id = seq++; copy.x = clamp(w.x+2,1,cols-1); copy.y = clamp(w.y+2,1,rows-1);
    current().widgets.push(copy); setSelected(copy.id); renderAll();
  }
  ["page","pageInner","pageMargins"].forEach(id=>{
    document.getElementById(id).addEventListener('contextmenu',(e)=>{
      e.preventDefault(); openCtx(e.clientX, e.clientY);
    });
  });
  window.addEventListener('mousedown',(e)=>{ if(!ctx.contains(e.target)) closeCtx(); });
  ctx.addEventListener('click',(e)=>{
    const item = e.target.closest('.ctx-item'); if(!item) return;
    const act = item.getAttribute('data-act'); closeCtx();
    if(act==='add-table') document.querySelector('.block[data-type="table"]').click();
    else if(act==='add-chart') document.querySelector('.block[data-type="chart"]').click();
    else if(act==='add-kpi') document.querySelector('.block[data-type="kpi"]').click();
    else if(act==='add-button') document.querySelector('.block[data-type="button"]').click();
    else if(act==='auto-layout') autoLayout();
    else if(act==='duplicate') duplicateSelected();
    else if(act==='delete'){ if(selectedId) $("#pDelete").click(); }
  });

  // Compile & download (richer payload)
  $("#compile").onclick=async()=>{
    const payload={
      project: $("#projectName").value || "Workbook",
      sheets,
      settings: {
        enabled: $("#smartSave").checked,
        baseName: $("#baseName")?.value || "Report_",
        dateFormat: $("#dateFmt")?.value || "yyyy-mm-dd",
        requireCopyOnOpen: $("#reqCopy")?.checked ?? true,
        templateTag: "TEMPLATE",
        sequenceIfExists: true,
        page
      }
    };
    const res = await fetch('/api/compile', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    if(!res.ok){ alert('Compile failed'); return; }
    const blob = await res.blob();
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = (payload.project || 'Workbook').replace(/\s+/g,'_') + '.xlsx';
    a.click();
  };

  // First render
  renderAll(); updateDeleteButton();
})();
</script>
</body>
</html>
